<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>位置情報ロガー</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; min-height: 200px; overflow-y: scroll; margin-top: 20px; background-color: #f9f9f9; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .red-text { color: red; }
    </style>
</head>
<body>
    <h1>位置情報ロガー</h1>
    <p>「ロギング開始」ボタンを押すと、現在の緯度、経度、**ダミーの歩数**、Unixタイムスタンプ（ミリ秒）を5秒ごとに記録します。データはCSV形式でダウンロードされます。</p>
    <p class="red-text">※ このページを開いている間だけ記録されます。ページを閉じたり、ブラウザを閉じると記録はリセットされます。</p>
    <button id="startButton">ロギング開始</button>
    <button id="stopButton" disabled>ロギング停止</button>
    <button id="downloadButton" disabled>データダウンロード (CSV)</button>
    
    <h2>記録されたデータ:</h2>
    <div id="log">
        <p>ログはここに表示されます...</p>
    </div>

    <script>
        let watchId; // Geolocation.watchPosition() のIDを格納
        const loggedData = []; // 記録されたデータを格納する配列
        const logDiv = document.getElementById('log');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const downloadButton = document.getElementById('downloadButton');

        // Geolocation APIが利用可能かチェック
        if (!navigator.geolocation) {
            logDiv.innerHTML = '<p class="red-text">お使いのブラウザは位置情報サービスに対応していません。</p>';
            startButton.disabled = true;
        }

        // 位置情報取得成功時のコールバック関数
        function success(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            // タイムスタンプはミリ秒単位のUnixタイムスタンプ
            const timestampMillis = position.timestamp; 
            
            // 歩数はロガーから直接取得できないため、現在はダミー値 (0) を使用します
            // 必要に応じて、後で手動でデータを加筆修正してください
            const dummySteps = 0; 

            // ご希望の形式: 緯度,経度,歩数,Unixタイムスタンプ（ミリ秒）
            const dataEntry = `${latitude.toFixed(6)},${longitude.toFixed(6)},${dummySteps},${timestampMillis}`;
            loggedData.push(dataEntry); // 配列に追加

            // 画面に表示（整形して表示）
            const formattedTime = new Date(timestampMillis).toLocaleString('ja-JP');
            const entryElement = document.createElement('div');
            entryElement.classList.add('log-entry');
            entryElement.innerHTML = `<strong>${formattedTime}</strong><br>${latitude.toFixed(6)},${longitude.toFixed(6)},${dummySteps},${timestampMillis}`;
            logDiv.prepend(entryElement); // 新しいエントリを上に追加
            logDiv.scrollTop = 0; // スクロール位置を一番上に

            console.log(dataEntry);

            downloadButton.disabled = false; // データが記録されたらダウンロードボタンを有効にする
        }

        // 位置情報取得失敗時のコールバック関数
        function error(err) {
            let errorMessage;
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMessage = "位置情報の利用が許可されませんでした。";
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMessage = "位置情報を取得できませんでした。";
                    break;
                case err.TIMEOUT:
                    errorMessage = "位置情報の取得がタイムアウトしました。";
                    break;
                default:
                    errorMessage = `不明なエラーが発生しました: ${err.message}`;
                    break;
            }
            logDiv.innerHTML = `<p class="red-text">エラー: ${errorMessage}</p>`;
            console.error(`エラー(${err.code}): ${err.message}`);
            stopLogging(); // エラー発生時はロギングを停止
        }

        // ロギング開始
        function startLogging() {
            startButton.disabled = true;
            stopButton.disabled = false;
            downloadButton.disabled = true; 
            logDiv.innerHTML = '<p>ロギングを開始しました...</p>';
            loggedData.length = 0; // 既存データをクリア

            watchId = navigator.geolocation.watchPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 5000, 
                maximumAge: 0 
            });
            console.log("ロギング開始");
        }

        // ロギング停止
        function stopLogging() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                logDiv.prepend('<p>ロギングを停止しました。</p>');
                console.log("ロギング停止");
            }
            startButton.disabled = false;
            stopButton.disabled = true;
            if (loggedData.length > 0) {
                downloadButton.disabled = false;
            }
        }

        // データダウンロード (CSV形式)
        function downloadData() {
            if (loggedData.length === 0) {
                alert("記録されたデータがありません。");
                return;
            }

            // ヘッダー行を追加
            const header = "latitude,longitude,steps,timestamp";
            const dataStr = header + '\n' + loggedData.join('\n'); // ヘッダーとデータを改行で結合

            const blob = new Blob([dataStr], { type: 'text/csv;charset=utf-8;' }); // CSVファイルとして保存
            const url = URL.createObjectURL(blob); 

            const a = document.createElement('a');
            a.href = url;
            // ファイル名を location_log_YYYY-MM-DD.csv とします
            a.download = `location_log_${new Date().toISOString().slice(0,10)}.csv`; 
            document.body.appendChild(a);
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
        }

        startButton.addEventListener('click', startLogging);
        stopButton.addEventListener('click', stopLogging);
        downloadButton.addEventListener('click', downloadData);
    </script>
</body>
</html>